name: Test Xcode Build on Self-Hosted Runner

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  xcode-build-test:
    name: Test Xcode Build
    runs-on: [self-hosted, macOS, metamask-mobile]

    env:
      ISSUES_FOUND: ""
      WARNINGS_FOUND: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === SYSTEM REQUIREMENTS CHECKS ===
      - name: Check system information
        run: |
          echo "üñ•Ô∏è System Information:"
          echo "- macOS Version: $(sw_vers -productVersion)"
          echo "- macOS Build: $(sw_vers -buildVersion)"
          echo "- Architecture: $(uname -m)"
          echo "- Hostname: $(hostname)"
          echo "- Available Memory: $(sysctl -n hw.memsize | awk '{ byte =$1 /1024/1024/1024; print byte " GB" }')"
          echo "- CPU Cores: $(sysctl -n hw.ncpu)"
          echo "- CPU Brand: $(sysctl -n machdep.cpu.brand_string || echo 'Unknown')"

      - name: Check essential development tools
        run: |
          echo "üîß Essential Development Tools:"

          # Git version
          if command -v git &> /dev/null; then
            echo "‚úÖ Git Version: $(git --version)"
          else
            echo "‚ùå Git not found"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Git not installed; " >> $GITHUB_ENV
          fi

          # Homebrew
          if command -v brew &> /dev/null; then
            echo "‚úÖ Homebrew Version: $(brew --version | head -1)"
            echo "- Homebrew Path: $(which brew)"
          else
            echo "‚ö†Ô∏è Homebrew not found (recommended for iOS development)"
            echo "WARNINGS_FOUND=${WARNINGS_FOUND}Homebrew not installed; " >> $GITHUB_ENV
          fi

          # Watchman (recommended by Facebook)
          if command -v watchman &> /dev/null; then
            echo "‚úÖ Watchman Version: $(watchman --version)"
          else
            echo "‚ö†Ô∏è Watchman not found (recommended for better file watching performance)"
            echo "WARNINGS_FOUND=${WARNINGS_FOUND}Watchman not installed; " >> $GITHUB_ENV
          fi

          # xcbeautify (for prettier build output)
          if command -v xcbeautify &> /dev/null; then
            echo "‚úÖ xcbeautify found (for prettier Xcode output)"
          else
            echo "‚ö†Ô∏è xcbeautify not found (will use raw xcodebuild output)"
            echo "WARNINGS_FOUND=${WARNINGS_FOUND}xcbeautify not installed; " >> $GITHUB_ENV
          fi

      # === XCODE & IOS ENVIRONMENT CHECKS ===
      - name: Check Xcode installation
        run: |
          echo "üî® Xcode Environment:"
          if command -v xcode-select &> /dev/null; then
            echo "‚úÖ Xcode Path: $(xcode-select -p)"

            if xcodebuild -version &> /dev/null; then
              echo "‚úÖ Xcode Version: $(xcodebuild -version | head -1)"
              echo "‚úÖ Xcode Build Version: $(xcodebuild -version | tail -1)"
            else
              echo "‚ùå Xcodebuild command failed"
              echo "ISSUES_FOUND=${ISSUES_FOUND}xcodebuild command not working; " >> $GITHUB_ENV
            fi

            # Check Command Line Tools
            if xcode-select -p | grep -q "CommandLineTools"; then
              echo "‚ö†Ô∏è Using Command Line Tools only (Xcode.app recommended)"
              echo "WARNINGS_FOUND=${WARNINGS_FOUND}Using Command Line Tools only; " >> $GITHUB_ENV
            else
              echo "‚úÖ Using full Xcode.app installation"
            fi

            # Available SDKs
            echo "üìö Available iOS SDKs:"
            xcodebuild -showsdks | grep iOS | head -3 || echo "No iOS SDKs found"

            # Check iOS SDK version
            if IOS_SDK_VERSION=$(xcodebuild -showsdks | grep iOS | tail -1 | awk '{print $4}' 2>/dev/null); then
              echo "‚úÖ Latest iOS SDK: $IOS_SDK_VERSION"
            else
              echo "‚ùå No iOS SDKs available"
              echo "ISSUES_FOUND=${ISSUES_FOUND}No iOS SDKs available; " >> $GITHUB_ENV
            fi

          else
            echo "‚ùå Xcode not found - xcode-select command missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Xcode not installed; " >> $GITHUB_ENV
          fi

      - name: Check iOS Simulators
        run: |
          echo "üì± iOS Simulator Environment:"

          # List all available simulators
          echo "Available iOS Simulators:"
          xcrun simctl list devicetypes | grep iPhone | head -5

          # Check available simulator runtimes
          echo ""
          echo "Available iOS Runtimes:"
          xcrun simctl list runtimes | grep iOS | head -3

          # Check for specific iPhone models
          echo ""
          echo "Checking for iPhone simulators:"
          if xcrun simctl list devices available | grep -q "iPhone 15"; then
            echo "‚úÖ iPhone 15 simulator available"
          elif xcrun simctl list devices available | grep -q "iPhone 14"; then
            echo "‚úÖ iPhone 14 simulator available (fallback option)"
            AVAILABLE_IPHONE=$(xcrun simctl list devices available | grep "iPhone 14" | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
            echo "SIMULATOR_ID=$AVAILABLE_IPHONE" >> $GITHUB_ENV
          elif xcrun simctl list devices available | grep -q "iPhone 13"; then
            echo "‚úÖ iPhone 13 simulator available (fallback option)"
            AVAILABLE_IPHONE=$(xcrun simctl list devices available | grep "iPhone 13" | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
            echo "SIMULATOR_ID=$AVAILABLE_IPHONE" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è No modern iPhone simulators found, using first available"
            AVAILABLE_IPHONE=$(xcrun simctl list devices available | grep iPhone | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
            echo "Will use: $AVAILABLE_IPHONE"
            echo "SIMULATOR_ID=$AVAILABLE_IPHONE" >> $GITHUB_ENV
          fi

      # === NODE.JS ECOSYSTEM CHECKS ===
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Verify Node.js ecosystem
        run: |
          echo "üì¶ Node.js Ecosystem:"

          # Verify exact versions match requirements
          EXPECTED_NODE_VERSION=$(cat .nvmrc)
          ACTUAL_NODE_VERSION=$(node -v | sed 's/v//')

          echo "- Expected Node.js: $EXPECTED_NODE_VERSION"
          echo "- Actual Node.js: $ACTUAL_NODE_VERSION"

          if [ "$EXPECTED_NODE_VERSION" = "$ACTUAL_NODE_VERSION" ]; then
            echo "‚úÖ Node.js version matches exactly"
          else
            echo "‚ö†Ô∏è Node.js version mismatch (may cause issues)"
          fi

          echo "- npm Version: $(npm -v)"
          echo "- Yarn Version: $(yarn -v)"

          # Check yarn version requirement
          EXPECTED_YARN_VERSION="1.22.22"
          ACTUAL_YARN_VERSION=$(yarn -v)
          if [ "$EXPECTED_YARN_VERSION" = "$ACTUAL_YARN_VERSION" ]; then
            echo "‚úÖ Yarn version matches requirement"
          else
            echo "‚ö†Ô∏è Yarn version mismatch - expected: $EXPECTED_YARN_VERSION, got: $ACTUAL_YARN_VERSION"
          fi

          # Verify yarn cache
          echo "- Yarn Cache: $(yarn cache dir)"

      # === RUBY ECOSYSTEM CHECKS ===
      - uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 #v1
        with:
          ruby-version: '3.1.6'
        env:
          BUNDLE_GEMFILE: ios/Gemfile
      - name: Check Ruby ecosystem
        run: |
          echo "üíé Ruby Ecosystem:"

          # Check Ruby version
          EXPECTED_RUBY_VERSION=$(cat .ruby-version)
          ACTUAL_RUBY_VERSION=$(ruby -v | awk '{print $2}')

          echo "- Expected Ruby: $EXPECTED_RUBY_VERSION"
          echo "- Actual Ruby: $ACTUAL_RUBY_VERSION"
          echo "- Ruby Path: $(which ruby)"

          # Check if using system Ruby (bad)
          if [ "$(which ruby)" = "/usr/bin/ruby" ]; then
            echo "‚ö†Ô∏è Using system Ruby - consider using rbenv or similar"
          else
            echo "‚úÖ Using non-system Ruby"
          fi

          # Check Ruby version requirement
          if [[ "$ACTUAL_RUBY_VERSION" > "$EXPECTED_RUBY_VERSION" ]] || [[ "$ACTUAL_RUBY_VERSION" = "$EXPECTED_RUBY_VERSION"* ]]; then
            echo "‚úÖ Ruby version meets requirement (>= $EXPECTED_RUBY_VERSION)"
          else
            echo "‚ùå Ruby version too old - need >= $EXPECTED_RUBY_VERSION"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Ruby version too old ($ACTUAL_RUBY_VERSION < $EXPECTED_RUBY_VERSION); " >> $GITHUB_ENV
          fi

          echo "- Gem Version: $(gem -v)"
          echo "- RubyGems Path: $(gem env home)"

      - name: Check bundler and CocoaPods
        run: |
          echo "‚òï Ruby Gems & CocoaPods:"

          # Check bundler
          if command -v bundle &> /dev/null; then
            echo "‚úÖ Bundler Version: $(bundle -v)"
          else
            echo "‚ùå Bundler not found"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Bundler not installed; " >> $GITHUB_ENV
          fi

          # Check CocoaPods
          if command -v pod &> /dev/null; then
            POD_VERSION=$(pod --version)
            echo "‚úÖ CocoaPods Version: $POD_VERSION"

            # Check expected CocoaPods version from Gemfile
            EXPECTED_POD_VERSION="1.16.2"
            if [[ "$POD_VERSION" = "$EXPECTED_POD_VERSION"* ]]; then
              echo "‚úÖ CocoaPods version matches Gemfile requirement"
            else
              echo "‚ö†Ô∏è CocoaPods version mismatch - Gemfile expects: $EXPECTED_POD_VERSION"
              echo "WARNINGS_FOUND=${WARNINGS_FOUND}CocoaPods version mismatch; " >> $GITHUB_ENV
            fi
          else
            echo "‚ùå CocoaPods not found"
            echo "ISSUES_FOUND=${ISSUES_FOUND}CocoaPods not installed; " >> $GITHUB_ENV
          fi

          # Check CocoaPods repo
          echo "- CocoaPods Repo: $(pod repo list | head -5)"

      # === PROJECT DEPENDENCY INSTALLATION ===
      - name: Install Node.js dependencies
        run: |
          echo "üì• Installing Node.js dependencies..."
          yarn --immutable --verbose
          echo "‚úÖ Node.js dependencies installed successfully"

      - name: Verify critical Node.js packages
        run: |
          echo "üîç Verifying critical Node.js packages..."

          # React Native
          if [ -d "node_modules/react-native" ]; then
            RN_VERSION=$(node -p "require('./node_modules/react-native/package.json').version")
            echo "‚úÖ React Native: $RN_VERSION"
          else
            echo "‚ùå react-native package missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}React Native package missing; " >> $GITHUB_ENV
          fi

          # React Native CLI
          if [ -d "node_modules/@react-native-community/cli" ]; then
            CLI_VERSION=$(node -p "require('./node_modules/@react-native-community/cli/package.json').version")
            echo "‚úÖ React Native CLI: $CLI_VERSION"
          else
            echo "‚ùå @react-native-community/cli package missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}React Native CLI package missing; " >> $GITHUB_ENV
          fi

          # MetaMask design system
          if [ -d "node_modules/@metamask/design-system-react-native" ]; then
            DS_VERSION=$(node -p "require('./node_modules/@metamask/design-system-react-native/package.json').version")
            echo "‚úÖ MetaMask Design System: $DS_VERSION"
          else
            echo "‚ùå @metamask/design-system-react-native package missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}MetaMask Design System package missing; " >> $GITHUB_ENV
          fi

          # Expo
          if [ -d "node_modules/expo" ]; then
            EXPO_VERSION=$(node -p "require('./node_modules/expo/package.json').version")
            echo "‚úÖ Expo: $EXPO_VERSION"
          else
            echo "‚ùå expo package missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Expo package missing; " >> $GITHUB_ENV
          fi

          # TypeScript
          if [ -d "node_modules/typescript" ]; then
            TS_VERSION=$(node -p "require('./node_modules/typescript/package.json').version")
            echo "‚úÖ TypeScript: $TS_VERSION"
          else
            echo "‚ùå typescript package missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}TypeScript package missing; " >> $GITHUB_ENV
          fi

      - name: Install Ruby gems
        run: |
          echo "üíé Installing Ruby gems..."
          cd ios
          bundle install --verbose
          echo "‚úÖ Ruby gems installed successfully"

      - name: Install iOS dependencies
        run: |
          echo "üçé Installing iOS CocoaPods dependencies..."
          cd ios

          # Show Podfile configuration
          echo "Podfile configuration:"
          echo "- New Architecture: $(grep -o 'newArchEnabled.*true' Podfile.properties.json || echo 'false')"

          # Install pods with verbose output
          pod install --repo-update --verbose
          echo "‚úÖ CocoaPods dependencies installed successfully"
        env:
          GITHUB_CI: "true"

      # === PROJECT CONFIGURATION CHECKS ===
      - name: Verify project configuration
        run: |
          echo "‚öôÔ∏è Project Configuration:"

          # Check environment files
          echo "Environment files:"
          for env_file in .js.env .ios.env .android.env .e2e.env; do
            if [ -f "$env_file" ]; then
              echo "‚úÖ $env_file exists"
            else
              echo "‚ö†Ô∏è $env_file missing (will be created from example)"
            fi
          done

          # Check TypeScript config
          if [ -f "tsconfig.json" ]; then
            echo "‚úÖ TypeScript configuration found"
          else
            echo "‚ùå tsconfig.json missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}TypeScript config missing; " >> $GITHUB_ENV
          fi

          # Check Metro config
          if [ -f "metro.config.js" ]; then
            echo "‚úÖ Metro bundler configuration found"
          else
            echo "‚ùå metro.config.js missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Metro config missing; " >> $GITHUB_ENV
          fi

          # Check app config
          if [ -f "app.config.js" ]; then
            echo "‚úÖ App configuration found"
          else
            echo "‚ùå app.config.js missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}App config missing; " >> $GITHUB_ENV
          fi

      - name: Verify iOS workspace and configuration
        run: |
          echo "üîç Verifying iOS workspace and configuration..."
          cd ios

          # Check workspace exists
          if [ -f "MetaMask.xcworkspace/contents.xcworkspacedata" ]; then
            echo "‚úÖ MetaMask.xcworkspace found"
          else
            echo "‚ùå MetaMask.xcworkspace not found"
            echo "ISSUES_FOUND=${ISSUES_FOUND}iOS workspace not found; " >> $GITHUB_ENV
          fi

          # Check Podfile
          if [ -f "Podfile" ]; then
            echo "‚úÖ Podfile found"
            echo "- iOS deployment target: $(grep 'platform :ios' Podfile)"
          else
            echo "‚ùå Podfile missing"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Podfile missing; " >> $GITHUB_ENV
          fi

          # Check Podfile.lock
          if [ -f "Podfile.lock" ]; then
            echo "‚úÖ Podfile.lock found"
            echo "- CocoaPods version: $(grep 'COCOAPODS:' Podfile.lock | head -1)"
          else
            echo "‚ùå Podfile.lock missing - pods not installed properly"
            echo "ISSUES_FOUND=${ISSUES_FOUND}Podfile.lock missing; " >> $GITHUB_ENV
          fi

          # List available schemes (if workspace exists)
          if [ -f "MetaMask.xcworkspace/contents.xcworkspacedata" ]; then
            echo ""
            echo "Available Xcode schemes:"
            xcodebuild -workspace MetaMask.xcworkspace -list | grep -A 20 "Schemes:" | tail -10 || echo "Could not list schemes"

            # Verify specific schemes exist
            if xcodebuild -workspace MetaMask.xcworkspace -list | grep -q "MetaMask$"; then
              echo "‚úÖ MetaMask scheme found"
            else
              echo "‚ùå MetaMask scheme not found"
              echo "ISSUES_FOUND=${ISSUES_FOUND}MetaMask scheme not found; " >> $GITHUB_ENV
            fi

            if xcodebuild -workspace MetaMask.xcworkspace -list | grep -q "MetaMask-QA"; then
              echo "‚úÖ MetaMask-QA scheme found"
            else
              echo "‚ö†Ô∏è MetaMask-QA scheme not found"
              echo "WARNINGS_FOUND=${WARNINGS_FOUND}MetaMask-QA scheme not found; " >> $GITHUB_ENV
            fi
          fi

      # === BUILD PROCESS (DISABLED) ===
      - name: Build readiness check
        run: |
          echo "üèóÔ∏è Build Process Status: DISABLED"
          echo ""
          echo "‚ÑπÔ∏è  Actual iOS build is currently disabled to prevent file pollution on runners."
          echo "‚ÑπÔ∏è  This workflow only performs dependency and environment validation."
          echo ""
          echo "To enable building, uncomment and modify the build steps in this workflow."
          echo ""

          # Show what build command would be used
          DESTINATION="platform=iOS Simulator,name=iPhone 15,OS=latest"
          if [ ! -z "$SIMULATOR_ID" ]; then
            DESTINATION="platform=iOS Simulator,id=$SIMULATOR_ID"
          fi

          echo "üìã Build command that would be executed:"
          echo "   cd ios"
          echo "   xcodebuild -workspace MetaMask.xcworkspace \\"
          echo "     -scheme MetaMask \\"
          echo "     -configuration Debug \\"
          echo "     -destination \"$DESTINATION\" \\"
          echo "     -derivedDataPath build/ \\"
          echo "     clean build"

      - name: Environment validation summary
        run: |
          echo "üéâ Environment Validation Complete!"
          echo ""
          echo "=== VALIDATION SUMMARY ==="
          echo "‚úÖ System information collected"
          echo "‚úÖ Development tools checked"
          echo "‚úÖ Node.js ecosystem verified"
          echo "‚úÖ Ruby ecosystem verified"
          echo "‚úÖ Dependencies analyzed"
          echo "‚úÖ iOS workspace analyzed"
          echo "‚ÑπÔ∏è  Build process disabled (validation only)"
          echo ""

          # Display issues found
          if [ -n "$ISSUES_FOUND" ] && [ "$ISSUES_FOUND" != "" ]; then
            echo "‚ùå CRITICAL ISSUES FOUND:"
            IFS=';' read -ra ISSUES_ARRAY <<< "$ISSUES_FOUND"
            for issue in "${ISSUES_ARRAY[@]}"; do
              if [ -n "$issue" ] && [ "$issue" != "" ]; then
                echo "   ‚Ä¢ $issue"
              fi
            done
            echo ""
          fi

          # Display warnings found
          if [ -n "$WARNINGS_FOUND" ] && [ "$WARNINGS_FOUND" != "" ]; then
            echo "‚ö†Ô∏è  WARNINGS FOUND:"
            IFS=';' read -ra WARNINGS_ARRAY <<< "$WARNINGS_FOUND"
            for warning in "${WARNINGS_ARRAY[@]}"; do
              if [ -n "$warning" ] && [ "$warning" != "" ]; then
                echo "   ‚Ä¢ $warning"
              fi
            done
            echo ""
          fi

          # Final status
          if [ -z "$ISSUES_FOUND" ] || [ "$ISSUES_FOUND" = "" ]; then
            if [ -z "$WARNINGS_FOUND" ] || [ "$WARNINGS_FOUND" = "" ]; then
              echo "üéä RESULT: Environment is fully ready for MetaMask iOS development! üöÄ"
            else
              echo "‚úÖ RESULT: Environment is ready with minor recommendations above."
            fi
          else
            echo "üîß RESULT: Environment needs attention - please address critical issues above."
            echo ""
            echo "üí° TIP: Fix critical issues and re-run this workflow to verify."
          fi

          echo ""
          echo "üìä Validation completed without modifying runner environment."
